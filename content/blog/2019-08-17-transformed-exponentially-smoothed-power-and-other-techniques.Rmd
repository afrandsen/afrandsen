---
title: Transformed Exponentially Smoothed Power and Other Techniques
author: Andreas Frandsen
date: '2019-08-17'
slug: transformed-exponentially-smoothed-power-and-other-techniques
categories: []
lastmod: 0
tags:
  - R
  - Training
  - Power
  - Power meter
  - Watt
  - Smoothing
  - TDF
  - Lactate
  - LT
  - Threshold
  - Heartrate
  - AU
  - Aarhus University
  - Statistics
description: "A statistic breakdown of the different components regarding normalization of power. A blog post by afrandsen."
bibliography: C:/Users/AKF/Documents/afrandsen/references/transformed-exponentially-smoothed-power-and-other-techniques/references.bib
nocite: '@*'
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      dev = c("svg"))
knitr::opts_chunk$set(dev.args=list(bg="transparent"))
library(tidyverse)
```


A lot have been said regarding smoothing and transformation of exerted power. Different terms have been used by physiologists, without a proper explanation of the statistical aspects behind their metrics. The time has come to take the no bullshit approach towards this topic. Thus this article seeks to explain openly the how and why of these metrics. And finally provide a more robust model, in terms of unbiasedness.

# Pseudo-Stochasticity of Power

# Existing Metrics

Andrew Coggan, Philip Skiba and Strava has each provided their own metrics regarding smoothing and transformation of power. I will refer to these as Coggan Power, Skiba Power and Strava Power, you can check out the correct metric names yourself.

## Coggan Power

Developed by Andrew R. Coggan. Also known as IsoPower in GoldenCheetah. Explained in [@Coggan2012].

### Technique

Calculate simple 30 s moving average. Take fourth power. Take mean. Take fourth root.

### Issues

Biased towards the last

$$\Delta = x - 30$$

seconds of the ride/interval, where $x$ is the full ride/interval in seconds.

## Skiba Power

Developed by Philip F. Skiba. Explained in [@Skiba2008].

### Technique

Calculate 25 s exponential moving average. Take fourth power. Take mean. Take fourth root.

# Issues

Biased towards 0.

## Strava Power

Developed by Strava, seems to be equivalent to Skiba Power. Somewhat explained in [@Strava].

### Technique

See Skiba Power.

### Issues

See Skiba Power.

# Relation Between Power and Lactate

To find how the body's physiological response is to exercise intensity, we will look at how lactate acid levels in the blood increases with intensity. We expect that the lactate acid level is an increasing function of exercise intensity, but is it a linear function? Let's try to visualize it first.

We will take look at a very small data sample taking from my body some years ago, originally it was performed to measure my lactate threshold.^[Data measured using Lactate Analyzer and a Wattbike, accuracy +/- 2%.]

```{r lactate-power, fig.width=3.5, fig.asp=0.8, fig.cap="Exponential curvature is observed.", fig.align='center'}
watt    <- c(175,200,228,251,276)
lactate <- c(1.5,1.8,2.3,2.9,4.5)
data <- tibble(watt, lactate)

ggplot(data, aes(watt, lactate))+
  geom_point()+
  expand_limits(x = 0, y = 0)+
  xlab(expression(italic("Intensity")))+
  ylab(expression(italic("Lactate")))+
  coord_cartesian(ylim = c(0, 5), xlim = c(0.1,300))+
  scale_x_continuous(expand = c(0,0), labels = scales::unit_format(suffix = " W"))+
  scale_y_continuous(expand = c(0,0), labels = scales::unit_format(suffix = " mmol/L"))+
  theme_classic()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid = element_blank(),
        plot.margin = margin(10, 14, 0, 0),
        axis.text.y = element_text(angle = 30)
)
```

Given the fact that I haven't transformed the axes, we observe that the relationship is nonlinear. This fits well with the theory that the body can't keep up with lactate acid being produced at high levels of effort as observed in [@Faude2009]. Thus it accumulates very fast in the body at high intensities. We also observe that the relation is exponential or curvilinear. So let's try to fit an (natural) exponential model to the data, of the form

$$f(x)=\alpha \mathrm{e}^{\beta x},$$

where $x\in\mathbb{R}^+$. Let us at the same time try to fit another exponential model, of the form

$$f(x)=\alpha x^{\beta},$$

which I (misleadingly) will refer to as a power model, where $x\in\mathbb{R}^+$. We will have to set some initial parameters (this is essentially a very hard part). Next up: code! Scroll down to see the results.

```{r lactate-power-model, include=TRUE, echo=TRUE}
# Fit Exponential model
model.1 <- nls(formula = lactate ~ a * exp(b*watt),
             start = list(a=0.222, b=0.01))
# Fit Power model
model.2 <- nls(formula = lactate ~ a*watt^b,
               start = list(a=0.000001, b=2.3))

models <- tibble(model.1, model.2)

RMSE <- function(model){
  sqrt(mean((predict(model)-lactate)^2))
}

# Statistical summary of Exponential model
summary(model.1)
# Statistical summary of Power model
summary(model.2)

# Calculate RMSE for both models
map_dbl(models, RMSE)
```

We achieve the following equation for the exponential model

$$f(x)=0.156875\cdot \mathrm{e}^{0.012003 x},$$

with an [RMSE](https://en.wikipedia.org/wiki/Root-mean-square_deviation) of 0.1944 and a [SE](https://en.wikipedia.org/wiki/Standard_error) of 0.2509.

The power model has this equation

$$f(x)=0.000000754\cdot x^{2.765},$$

with an RMSE of 0.2567 and a SE of 0.3314. Let's visualize it.

```{r, lactate-power-fit, fig.width=3.5, fig.asp=0.8, fig.cap="Exponential model provides best fit.", fig.align='center'}
ggplot(data, aes(x = watt,y = lactate))+
  geom_point()+
  #geom_smooth(method = "nls", method.args = list(formula=y~a*exp(b*x), start=list(a=0.222, b=0.010)), se=FALSE, aes(color="red"))+
  #geom_smooth(method = "nls", method.args = list(formula=y~a*x^b, start=list(a=0.000001,b=2)), se=FALSE, aes(color="blue"))+
  stat_function(fun=function(x) coef(model.1)[[1]]*exp(coef(model.1)[[2]]*x), aes(color = "1", group = 1))+
  stat_function(fun=function(x) coef(model.2)[[1]]*x^(coef(model.2)[[2]]), aes(color="2", group = 1))+
  expand_limits(x = 0, y = 0)+
  xlab(expression(italic("Intensity")))+
  ylab(expression(italic("Lactate")))+
  coord_cartesian(ylim = c(0, 5), xlim = c(0.1, 300))+
  scale_x_continuous(expand = c(0,0), labels = scales::unit_format(suffix = " W"))+
  scale_y_continuous(expand = c(0,0), labels = scales::unit_format(suffix = " mmol/L"))+
  theme_classic()+
  scale_color_discrete(labels = c("Exp", "Power"))+
  theme(
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid = element_blank(),
        plot.margin = margin(10, 14, 0, 0),
        axis.text.y = element_text(angle = 30),
        legend.title = element_blank(),
        legend.justification = c(1, 0),
        legend.position = c(1, 0.05)
)
```


# Half-Life of Heartrate

# Statistical Averages

A great amount of statistical averages exists when one wants to examine data. Some of these methods are as of today used in examining data from power meters.

Down below I will provide the some of the various formulas including negatives related to each method.

## Arithmetic Average

Is calculated as

$$\bar{x} = \frac{1}{n}\sum_{i=1}^n x_i,$$

where $i=1,\dots,n$.

## Median

## Simple Moving Average

$$\bar{x}_\text{SMA} = \frac{1}{n} \sum x_i $$

## Weighted Moving Average

## Exponential Moving Average

Is calculated as

$$\begin{align} s_0 &= x_0\\ s_t &= \alpha s_t+(1-\alpha)s_{t-1},\end{align}$$

where $t=1,\dots,n$.

## Unbiased Exponential Moving Average

### Normalization Factor

```{r scale, fig.width=3.5, fig.asp=0.8, fig.cap="The scaling factor converges towards 100 %.", fig.align='center'}
w <- c(rep(1,201))
index <- c(seq(0,200))
ratio <- 1 - exp(-1/(25/log(2)))
scale <- c(stats::filter(w * ratio, 1 - ratio, "recursive", init = 0))

data <- tibble(index, scale)

ggplot(data, aes(index, scale))+
  geom_area(aes(fill = "1"), alpha = 0.4)+
  expand_limits(x = 0, y = 0)+
  xlab(expression(italic("i")))+
  ylab(expression(italic("Scale")))+
  coord_cartesian(ylim = c(0, 1),xlim = c(0,200))+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), labels = scales::percent_format(accuracy = 1))+
  theme_classic()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid = element_blank(),
        plot.margin = margin(10, 10, 0, 0)
)
```

```{r smoothing, fig.width=4.1, fig.asp=0.8, message=FALSE}
Test <- read_csv("C:/Users/AKF/Temp/Test.csv", col_names = FALSE)
ewma.filter <- function (x, ratio) {
  c(stats::filter(x * ratio, 1 - ratio, "recursive", init = 0))
}

ewma.filter.s <- function (x, ratio) {
  s <- c(stats::filter(x * ratio, 1 - ratio, "recursive", init = 0))
  w <- c(rep(1,length(x)))
  scale <- c(stats::filter(w * ratio, 1 - ratio, "recursive", init = 0))
  
  s/scale
}

sm.filter <- function(x, n){
  c(stats::filter(x, rep(1 / n, n), sides = 1))
} 

smoothed.1 <- ewma.filter(Test$X1,1/26)
smoothed.2 <- ewma.filter.s(Test$X1, 1 - exp(-1/(25/log(2))))
smoothed.3 <- sm.filter(Test$X1, 30)

Test <- mutate(Test, time = seq(1,length(Test$X1),1))
Test <- mutate(Test, model.1 = smoothed.1)
Test <- mutate(Test, model.2 = smoothed.2)
Test <- mutate(Test, model.3 = smoothed.3)

ggplot(Test, aes(time))+
  geom_line(aes(y = model.2))+
  expand_limits(x = 0, y = 0)+
  xlab(expression(italic("Time")))+
  ylab(expression(italic("Intensity")))+
  scale_x_continuous(expand = c(0,0), labels = scales::unit_format(suffix = " s",big.mark = ""))+
  scale_y_continuous(expand = c(0,0), labels = scales::unit_format(suffix = " W"))+
  theme_classic()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid = element_blank(),
        plot.margin = margin(10, 10, 0, 0)
)

ggplot(Test, aes(time))+
  geom_line(aes(y = X1))+
  expand_limits(x = 0, y = 0)+
  xlab(expression(italic("Time")))+
  ylab(expression(italic("Intensity")))+
  scale_x_continuous(expand = c(0,0), labels = scales::unit_format(suffix = " s", big.mark = ""))+
  scale_y_continuous(expand = c(0,0), labels = scales::unit_format(suffix = " W"))+
  theme_classic()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid = element_blank(),
        plot.margin = margin(10, 10, 0, 0)
)

ggplot(Test[0:120,], aes(time))+
  geom_line(aes(y = model.1, color = "1", group = 1))+
  geom_line(aes(y = model.2, color = "2", group = 1))+
  geom_line(aes(y = model.3, color = "3", group = 1))+
  geom_vline(xintercept = c(30), linetype = "dashed")+
  expand_limits(x = 0, y = 0)+
  xlab(expression(italic("Time")))+
  ylab(expression(italic("Intensity")))+
  scale_x_continuous(expand = c(0,0), labels = scales::unit_format(suffix = " s",big.mark = ""))+
  scale_y_continuous(expand = c(0,0), labels = scales::unit_format(suffix = " W"))+
  theme_classic()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid = element_blank(),
        plot.margin = margin(10, 10, 0, 0)
)
```


*Disclaimer:*  
*I'm not a physiologist and I'm not affiliated with any company. And yes I wrote all of this shit just out of pure interest.*

# References
